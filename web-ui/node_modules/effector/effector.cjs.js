function e(e,t){for(let r in e)t(e[r],r)}function t(e,t){e.forEach(t)}function r(e,t){if(!e)throw Error(t)}function a(e,t){Q={parent:Q,value:e,template:O(e,'template')||X(),sidRoot:O(e,'sidRoot')||Q&&Q.sidRoot};try{return t()}finally{Q=A(Q)}}function n({node:e=[],from:r,source:a,parent:n=r||a,to:o,target:i,child:l=o||i,scope:s={},meta:f={},family:d={type:'regular'},regional:c}={}){let u=ee(n),p=ee(d.links),m=ee(d.owners),h=[];t(e,(e=>e&&W(h,e)));let g={id:K(),seq:h,next:ee(l),meta:f,scope:s,family:{type:d.type||"crosslink",links:p,owners:m}};return t(p,(e=>W(z(e),g))),t(m,(e=>W(M(e),g))),t(u,(e=>W(e.next,g))),c&&Q&&Z(C(Q),[g]),g}function o(e,r,a){let n=De,o=null,i=Ie;if(e.target&&(r=e.params,a=e.defer,n='page'in e?e.page:n,e.stack&&(o=e.stack),i=N(e)||i,e=e.target),i&&Ie&&i!==Ie&&(Ie=null),Array.isArray(e))for(let t=0;t<e.length;t++)$e('pure',n,S(e[t]),o,r[t],i);else $e('pure',n,S(e),o,r,i);if(a&&!qe)return;let l,s,f,d,c,u,p={isRoot:qe,currentPage:De,scope:Ie,isWatch:Fe,isPure:Ee};qe=0;e:for(;d=Ce();){let{idx:e,stack:r,type:a}=d;f=r.node,De=c=r.page,Ie=N(r),c?u=c.reg:Ie&&(u=Ie.reg);let n=!!c,o=!!Ie,i={fail:0,scope:f.scope};l=s=0;for(let t=e;t<f.seq.length&&!l;t++){let d=f.seq[t];if(d.order){let{priority:n,barrierID:o}=d.order,i=o?c?`${c.fullID}_${o}`:o:0;if(t!==e||a!==n){o?Oe.has(i)||(Oe.add(i),Ae(t,r,n,o)):Ae(t,r,n);continue e}o&&Oe.delete(i)}switch(d.type){case'mov':{let e,t=d.data;switch(t.from){case w:e=C(r);break;case"a":case'b':e=r[t.from];break;case"value":e=t.store;break;case"store":if(u&&!u[t.store.id])if(n){let e=Pe(c,t.store.id);r.page=c=e,e?u=e.reg:o?(Le(Ie,t.store,0,1,t.softRead),u=Ie.reg):u=void 0}else o&&Le(Ie,t.store,0,1,t.softRead);e=ke(u&&u[t.store.id]||t.store)}switch(t.to){case w:r.value=e;break;case"a":case'b':r[t.to]=e;break;case"store":Ve(c,Ie,f,t.target).current=e}break}case'compute':let e=d.data;if(e.fn){Fe='watch'===O(f,'op'),Ee=e.pure;let t=e.safe?(0,e.fn)(C(r),i.scope,r):Te(i,e.fn,r);e.filter?s=!t:r.value=t,Fe=p.isWatch,Ee=p.isPure}}l=i.fail||s}if(!l){let e=C(r),a=N(r);if(t(f.next,(t=>{$e('child',c,t,r,e,a)})),a){O(f,'needFxCounter')&&$e('child',c,a.fxCount,r,e,a),O(f,'storeChange')&&$e('child',c,a.storeChange,r,e,a),O(f,'warnSerialize')&&$e('child',c,a.warnSerializeNode,r,e,a);let n=a.additionalLinks[f.id];n&&t(n,(t=>{$e('child',c,t,r,e,a)}))}}}qe=p.isRoot,De=p.currentPage,Ie=N(p)}function i(t,r="combine"){let a=r+'(',n='',o=0;return e(t,(e=>{o<25&&(null!=e&&(a+=n,a+=F(e)?q(e).fullName:e.toString()),o+=1,n=', ')})),a+')'}function l(e,t){let r,a,n=e;if(t){let n=q(t);0===e.length?(r=n.path,a=n.fullName):(r=n.path.concat([e]),a=0===n.fullName.length?e:n.fullName+'/'+e)}else r=0===e.length?[]:[e],a=e;return{shortName:n,fullName:a,path:r}}function s(e,t){let r=t?e:e[0];ne(r);let a=r.or,n=r.and;if(n){let r=t?n:n[0];if(te(r)&&'and'in r){let r=s(n,t);e=r[0],a={...a,...r[1]}}else e=n}return[e,a]}function f(e,...t){let r=X();if(r){let a=r.handlers[e];if(a)return a(r,...t)}}function d(e,t){let r=We({or:t,and:'string'==typeof e?{name:e}:e}),a=(e,...t)=>(H(!O(a,'derived'),'call of derived event','createEvent'),H(!Ee,'unit call from pure function','operators like sample'),De?((e,t,r,a)=>{let n=De,o=null;if(t)for(o=De;o&&o.template!==t;)o=A(o);_e(o);let i=e.create(r,a);return _e(n),i})(a,i,e,t):a.create(e,t)),i=X(),l=Object.assign(a,{graphite:n({meta:Ze("event",a,r),regional:1}),create:e=>(o({target:a,params:e,scope:Ie}),e),watch:e=>Xe(a,e),map:e=>et(a,k,e,[be()]),filter:e=>et(a,"filter",e.fn?e:e.fn,[be(de,1)]),filterMap:e=>et(a,'filterMap',e,[be(),ge((e=>!ae(e)),1)]),prepend(e){let t=d('* \u2192 '+a.shortName,{parent:A(a)});return f('eventPrepend',S(t)),Qe(t,a,[be()],'prepend',e),Ye(a,t),t}});return null!=r&&r.domain&&r.domain.hooks.event(l),l}function c(e,a){let i=We(a),l=xe(e),s=d({named:'updates',derived:1});f('storeBase',l);let u=l.id,p={subscribers:new Map,updates:s,defaultState:e,stateRef:l,getState(){let e,t=l;if(De){let t=De;for(;t&&!t.reg[u];)t=A(t);t&&(e=t)}return!e&&Ie&&(Le(Ie,l,1),e=Ie),e&&(t=e.reg[u]),ke(t)},setState:e=>o({target:p,params:e,defer:1,scope:Ie}),reset:(...e)=>(t(e,(e=>p.on(e,(()=>p.defaultState)))),p),on:(e,a)=>(ie(e,'.on','first argument'),r(re(a),'second argument should be a function'),H(!O(p,'derived'),'.on in derived store','createStore'),t(Array.isArray(e)?e:[e],(e=>{p.off(e),$(p).set(e,Ke(tt(e,p,'on',fe,a)))})),p),off(e){let t=$(p).get(e);return t&&(t(),$(p).delete(e)),p},map(e,t){let r,a;te(e)&&(r=e,e=e.fn),H(ae(t),'second argument of store.map','updateFilter');let n=p.getState();X()?a=null:ae(n)||(a=e(n,t));let o=c(a,{name:`${p.shortName} \u2192 *`,derived:1,and:r}),i=tt(p,o,k,se,e);return we(j(o),{type:k,fn:e,from:l}),j(o).noInit=1,f('storeMap',l,i),o},watch(e,t){if(!t||!F(e)){let t=Xe(p,e);return f('storeWatch',l,e)||e(p.getState()),t}return r(re(t),'second argument should be a function'),e.watch((e=>t(p.getState(),e)))}},m=Ze("store",p,i),h=p.defaultConfig.updateFilter;p.graphite=n({scope:{state:l,fn:h},node:[ge(((e,t,r)=>(r.scope&&!r.scope.reg[l.id]&&(r.b=1),e))),ye(l),ge(((e,t,{a:r,b:a})=>!ae(e)&&(e!==r||a)),1),h&&be(se,1),pe({from:w,target:l})],child:s,meta:m,regional:1});let g=O(p,'serialize'),y=O(p,'derived'),b='ignore'===g,v=!g||b?0:g,x=O(p,'sid');return x&&(b||I(p,'storeChange',1),l.sid=x,v&&(l.meta={...null==l?void 0:l.meta,serialize:v})),x||b||y||I(p,'warnSerialize',1),r(y||!ae(e),"current state can't be undefined, use null instead"),Z(p,[s]),null!=i&&i.domain&&i.domain.hooks.store(p),y||(p.reinit=d(),p.reset(p.reinit)),p}function u(...e){let t,a,n;[e,n]=s(e);let o,i,l,f=e[e.length-1];if(re(f)?(a=e.slice(0,-1),t=f):a=e,1===a.length){let e=a[0];D(e)||(o=e,i=1)}if(!i&&(o=a,t)){l=1;let e=t;t=t=>e(...t)}return r(te(o),'shape should be an object'),rt(Array.isArray(o),!l,o,n,t)}function p(){let e={};return e.req=new Promise(((t,r)=>{e.rs=t,e.rj=r})),e.req.catch((()=>{})),e}function m(e,t){let a=We(re(e)?{handler:e}:e,t),i=d(re(e)?{handler:e}:e,t),l=S(i);I(l,'op',i.kind="effect"),i.use=e=>(r(re(e),'.use argument should be a function'),g.scope.handler=e,i),i.use.getCurrent=()=>g.scope.handler;let s=i.finally=d({named:'finally',derived:1}),f=i.done=s.filterMap({named:'done',fn({status:e,params:t,result:r}){if('done'===e)return{params:t,result:r}}}),u=i.fail=s.filterMap({named:'fail',fn({status:e,params:t,error:r}){if('fail'===e)return{params:t,error:r}}}),m=i.doneData=f.map({named:'doneData',fn:({result:e})=>e}),h=i.failData=u.map({named:'failData',fn:({error:e})=>e}),g=n({scope:{handlerId:O(l,'sid'),handler:i.defaultConfig.handler||(()=>r(0,`no handler used in ${i.getType()}`))},node:[ge(((e,t,r)=>{let a=t,n=a.handler;if(N(r)){let e=N(r).handlers[a.handlerId];e&&(n=e)}return e.handler=n,e}),0,1),ge((({params:e,req:t,handler:r,args:a=[e]},n,o)=>{let i=nt(o),l=ot(e,t,1,s,o,i),f=ot(e,t,0,s,o,i),[d,c]=at(r,f,a);d&&(te(c)&&re(c.then)?c.then(l,f):l(c))}),0,1)],meta:{op:'fx',fx:'runner'}});l.scope.runner=g,W(l.seq,ge(((e,{runner:t},r)=>{let a=A(r)?{params:e,req:{rs(e){},rj(e){}}}:e;return o({target:t,params:a,defer:1,scope:N(r)}),a.params}),0,1)),i.create=e=>{let t=p(),r={params:e,req:t};if(Ie){if(!Fe){let e=Ie;t.req.finally((()=>{Re(e)})).catch((()=>{}))}o({target:i,params:r,scope:Ie})}else o(i,r);return t.req};let y=i.inFlight=c(0,{serialize:'ignore'}).on(i,(e=>e+1)).on(s,(e=>e-1)).map({fn:e=>e,named:'inFlight'});I(s,'needFxCounter','dec'),I(i,'needFxCounter',1);let b=i.pending=y.map({fn:e=>e>0,named:'pending'});return Z(i,[s,f,u,m,h,b,y]),null!=a&&a.domain&&a.domain.hooks.effect(i),i}function h(e,t){ie(e,'merge','first argument');let r=d({name:i(e,'merge'),derived:1,and:t});return Qe(e,r,[],'merge'),r}function g(e,a){let n=0;return t(st,(t=>{t in e&&(r(null!=e[t],ft(a,t)),n=1)})),n}function y(e,r){let a=[];(function e(n){L(a,n)||(W(a,n),"store"===O(n,'op')&&O(n,'sid')&&r(n,O(n,'sid')),t(n.next,e),t(z(n),e),t(M(n),e))})(e)}function b(e,a){let n=Array.isArray(e)?new Map(e):e;if(n instanceof Map){let e={};return t(n,((t,n)=>{r(F(n),'Map key should be a unit'),a&&a(n,t),r(n.sid,'unit should have a sid'),r(!(n.sid in e),'duplicate sid found'),e[n.sid]=t})),e}return n}function v(e){let t=()=>e();return t.unsubscribe=()=>e(),t}Object.defineProperty(exports,'__esModule',{value:1});let x='undefined'!=typeof Symbol&&Symbol.observable||'@@observable',k='map',w='stack',S=e=>e.graphite||e,z=e=>e.family.owners,M=e=>e.family.links,j=e=>e.stateRef,C=e=>e.value,$=e=>e.subscribers,A=e=>e.parent,N=e=>e.scope,O=(e,t)=>S(e).meta[t],I=(e,t,r)=>S(e).meta[t]=r,q=e=>e.compositeName,F=e=>(re(e)||te(e))&&'kind'in e;const E=e=>t=>F(t)&&t.kind===e;let D=E("store"),R=E("event"),_=E("effect"),P=E("domain"),V=E("scope");var B={__proto__:null,unit:F,store:D,event:R,effect:_,domain:P,scope:V,attached:e=>_(e)&&1==O(e,'attached')};let L=(e,t)=>e.includes(t),T=(e,t)=>{let r=e.indexOf(t);-1!==r&&e.splice(r,1)},W=(e,t)=>e.push(t),H=(e,t,r)=>!e&&console.error(`${t} is deprecated${r?`, use ${r} instead`:''}`);const U=()=>{let e=0;return()=>""+ ++e};let G=U(),J=U(),K=U(),Q=null,X=()=>Q&&Q.template,Y=e=>(e&&Q&&Q.sidRoot&&(e=`${Q.sidRoot}|${e}`),e),Z=(e,r)=>{let a=S(e);t(r,(e=>{let t=S(e);"domain"!==a.family.type&&(t.family.type="crosslink"),W(z(t),a),W(M(a),t)}))},ee=(e=[])=>(Array.isArray(e)?e:[e]).flat().map(S),te=e=>'object'==typeof e&&null!==e,re=e=>'function'==typeof e,ae=e=>void 0===e,ne=e=>r(te(e)||re(e),'expect first argument be an object');const oe=(e,t,a,n)=>r(!(!te(e)&&!re(e)||!('family'in e)&&!('graphite'in e)),`${t}: expect ${a} to be a unit (store, event or effect)${n}`);let ie=(e,r,a)=>{Array.isArray(e)?t(e,((e,t)=>oe(e,r,`${t} item of ${a}`,''))):oe(e,r,a,' or array of units')},le=(e,r,a="target")=>t(ee(r),(t=>H(!O(t,'derived'),`${e}: derived unit in "${a}"`,"createEvent/createStore"))),se=(e,{fn:t},{a:r})=>t(e,r),fe=(e,{fn:t},{a:r})=>t(r,e),de=(e,{fn:t})=>t(e);const ce=(e,t,r,a)=>{let n={id:J(),type:e,data:t};return r&&(n.order={priority:r},a&&(n.order.barrierID=++ue)),n};let ue=0,pe=({from:e="store",store:t,target:r,to:a=(r?"store":w),batch:n,priority:o})=>ce('mov',{from:e,store:t,to:a,target:r},o,n),me=({fn:e,batch:t,priority:r,safe:a=0,filter:n=0,pure:o=0})=>ce('compute',{fn:e,safe:a,filter:n,pure:o},r,t),he=({fn:e})=>me({fn:e,priority:"effect"}),ge=(e,t,r)=>me({fn:e,safe:1,filter:t,priority:r&&"effect"}),ye=(e,t,r)=>pe({store:e,to:t?w:"a",priority:r&&"sampler",batch:1}),be=(e=de,t)=>me({fn:e,pure:1,filter:t}),ve={mov:pe,compute:me,filter:({fn:e,pure:t})=>me({fn:e,filter:1,pure:t}),run:he},xe=e=>({id:J(),current:e}),ke=({current:e})=>e,we=(e,t)=>{e.before||(e.before=[]),W(e.before,t)},Se=null;const ze=(e,t)=>{if(!e)return t;if(!t)return e;let r;return(e.v.type===t.v.type&&e.v.id>t.v.id||Ne(e.v.type)>Ne(t.v.type))&&(r=e,e=t,t=r),r=ze(e.r,t),e.r=e.l,e.l=r,e},Me=[];let je=0;for(;je<6;)W(Me,{first:null,last:null,size:0}),je+=1;const Ce=()=>{for(let e=0;e<6;e++){let t=Me[e];if(t.size>0){if(3===e||4===e){t.size-=1;let e=Se.v;return Se=ze(Se.l,Se.r),e}1===t.size&&(t.last=null);let r=t.first;return t.first=r.r,t.size-=1,r.v}}},$e=(e,t,r,a,n,o)=>Ae(0,{a:null,b:null,node:r,parent:a,value:n,page:t,scope:o},e),Ae=(e,t,r,a=0)=>{let n=Ne(r),o=Me[n],i={v:{idx:e,stack:t,type:r,id:a},l:null,r:null};3===n||4===n?Se=ze(Se,i):(0===o.size?o.first=i:o.last.r=i,o.last=i),o.size+=1},Ne=e=>{switch(e){case'child':return 0;case'pure':return 1;case'read':return 2;case"barrier":return 3;case"sampler":return 4;case"effect":return 5;default:return-1}},Oe=new Set;let Ie,qe=1,Fe=0,Ee=0,De=null,Re=e=>{Ie=e},_e=e=>{De=e};const Pe=(e,t)=>{if(e){for(;e&&!e.reg[t];)e=A(e);if(e)return e}return null};let Ve=(e,t,r,a,n)=>{let o=Pe(e,a.id);return o?o.reg[a.id]:t?(Le(t,a,n),t.reg[a.id]):a};const Be=e=>e;let Le=(e,r,a,n,o)=>{var i;let l=e.reg,s=r.sid,f=null==r||null===(i=r.meta)||void 0===i?void 0:i.serialize;if(l[r.id])return;let d={id:r.id,current:r.current,meta:r.meta};if(s&&s in e.sidValuesMap&&!(s in e.sidIdMap))d.current=(e.fromSerialize&&'ignore'!==f&&(null==f?void 0:f.read)||Be)(e.sidValuesMap[s]);else if(r.before&&!o){let o=0,i=a||!r.noInit||n;t(r.before,(t=>{switch(t.type){case k:{let r=t.from;if(r||t.fn){r&&Le(e,r,a,n);let o=r&&l[r.id].current;i&&(d.current=t.fn?t.fn(o):o)}break}case'field':o||(o=1,d.current=Array.isArray(d.current)?[...d.current]:{...d.current}),Le(e,t.from,a,n),i&&(d.current[t.field]=l[l[t.from.id].id].current)}}))}s&&(e.sidIdMap[s]=r.id),l[r.id]=d};const Te=(e,t,r)=>{try{return t(C(r),e.scope,r)}catch(t){console.error(t),e.fail=1}};let We=(t,r={})=>(te(t)&&(We(t.or,r),e(t,((e,t)=>{ae(e)||'or'===t||'and'===t||(r[t]=e)})),We(t.and,r)),r);const He=(e,t)=>{T(e.next,t),T(z(e),t),T(M(e),t)},Ue=(e,t,r)=>{let a;e.next.length=0,e.seq.length=0,e.scope=null;let n=M(e);for(;a=n.pop();)He(a,e),(t||r&&'sample'!==O(e,'op')||"crosslink"===a.family.type)&&Ue(a,t,'on'!==O(a,'op')&&r);for(n=z(e);a=n.pop();)He(a,e),r&&"crosslink"===a.family.type&&Ue(a,t,'on'!==O(a,'op')&&r)},Ge=e=>e.clear();let Je=(e,{deep:t}={})=>{let r=0;if(e.ownerSet&&e.ownerSet.delete(e),D(e))Ge($(e));else if(P(e)){r=1;let t=e.history;Ge(t.events),Ge(t.effects),Ge(t.stores),Ge(t.domains)}Ue(S(e),!!t,r)},Ke=e=>{let t=()=>Je(e);return t.unsubscribe=t,t},Qe=(e,t,r,a,o)=>n({node:r,parent:e,child:t,scope:{fn:o},meta:{op:a},family:{owners:[e,t],links:t},regional:1}),Xe=(e,t)=>(r(re(t),'.watch argument should be a function'),Ke(n({scope:{fn:t},node:[he({fn:de})],parent:e,meta:{op:'watch'},family:{owners:e},regional:1}))),Ye=(e,t,r="event")=>{A(e)&&A(e).hooks[r](t)},Ze=(e,t,r)=>{let a=We(r),n="domain"===e,o=G(),{sid:i=null,named:s=null,domain:f=null,parent:d=f}=a,c=s||a.name||(n?'':o),u=l(c,d),p={op:t.kind=e,name:t.shortName=c,sid:t.sid=Y(i),named:s,unitId:t.id=o,serialize:a.serialize,derived:a.derived,config:a};if(t.parent=d,t.compositeName=u,t.defaultConfig=a,t.thru=e=>(H(0,'thru','js pipe'),e(t)),t.getType=()=>u.fullName,!n){t.subscribe=e=>(ne(e),t.watch(re(e)?e:t=>e.next&&e.next(t))),t[x]=()=>t;let e=X();e&&(p.nativeTemplate=e)}return p};const et=(e,t,r,a)=>{let n;te(r)&&(n=r,r=r.fn);let o=d({name:`${e.shortName} \u2192 *`,derived:1,and:n});return Qe(e,o,a,t,r),o},tt=(e,t,r,a,n)=>{let o=j(t),i=pe({store:o,to:"a",priority:'read'});r===k&&(i.data.softRead=1);let l=[i,be(a)];return f('storeOnMap',o,l,D(e)&&j(e)),Qe(e,t,l,r,n)},rt=(t,a,n,o,l)=>{let s=t?e=>[...e]:e=>({...e}),d=t?[]:{},u=s(d),p=xe(u),m=xe(1);p.type=t?'list':'shape',p.noInit=1,f('combineBase',p,m);let h=c(u,{name:i(n),derived:1,and:o}),g=j(h);g.noInit=1,I(h,'isCombine',1);let y=ye(p);y.order={priority:'barrier'};let b=[ge(((e,t,r)=>(r.scope&&!r.scope.reg[p.id]&&(r.c=1),e))),y,pe({store:m,to:'b'}),ge(((e,{key:t},r)=>{if(r.c||e!==r.a[t])return a&&r.b&&(r.a=s(r.a)),r.a[t]=e,1}),1),pe({from:"a",target:p}),pe({from:"value",store:0,target:m}),pe({from:"value",store:1,target:m,priority:"barrier",batch:1}),ye(p,1),l&&be()];return e(n,((e,t)=>{if(!D(e))return r(!F(e)&&!ae(e),`combine expects a store in a field ${t}`),void(u[t]=d[t]=e);d[t]=e.defaultState,u[t]=e.getState();let a=Qe(e,h,b,'combine',l);a.scope.key=t;let n=j(e);we(p,{type:'field',field:t,from:n}),f('combineField',n,a)})),h.defaultShape=n,we(g,{type:k,from:p,fn:l}),X()||(h.defaultState=l?g.current=l(u):d),h};let at=(e,t,r)=>{try{return[1,e(...r)]}catch(e){return t(e),[0,null]}},nt=e=>{let t=N(e),r={ref:t};return t&&W(t.activeEffects,r),r},ot=(e,t,r,a,n,i)=>l=>{i.ref&&T(i.ref.activeEffects,i),o({target:[a,lt],params:[r?{status:'done',params:e,result:l}:{status:'fail',params:e,error:l},{value:l,fn:r?t.rs:t.rj}],defer:1,page:n.page,scope:i.ref})};const lt=n({node:[he({fn:({fn:e,value:t})=>e(t)})],meta:{op:'fx',fx:'sidechain'}}),st=['source','clock','target'],ft=(e,t)=>e+`: ${t} should be defined`;let dt=(e,t,a,n,o,i,l,s,p,m,g,y)=>{let b=!!o;r(!ae(a)||!ae(t),ft(e,'either source or clock'));let v=0;ae(a)?v=1:F(a)||(a=u(a)),ae(t)?t=a:(ie(t,e,'clock'),Array.isArray(t)&&(t=h(t))),v&&(a=t),s||l||(l=a.shortName);let x='none';(g||n)&&(F(n)?x='unit':(r(re(n),'`filter` should be function or unit'),x='fn')),o?(ie(o,e,'target'),le(e,o)):'none'===x&&m&&D(a)&&D(t)?o=c(i?i(ke(j(a)),ke(j(t))):ke(j(a)),{name:l,sid:y,or:s}):(o=d({name:l,derived:1,or:s}),f('sampleTarget',S(o)));let k=xe(),z=[];if('unit'===x){let[r,a]=ut(n,o,t,k,e);z=[...ct(a),...ct(r)]}let[M,C]=ut(a,o,t,k,e),$=Qe(t,o,[f('sampleSourceLoader'),pe({from:w,target:k}),...ct(C),ye(M,1,p),...z,ye(k),'fn'===x&&be(((e,t,{a:r})=>n(e,r)),1),i&&be(se),f('sampleSourceUpward',b)],e,i);return Z(a,[$]),Object.assign($.meta,s,{joint:1}),o};const ct=e=>[ye(e),ge(((e,t,{a:r})=>r),1)],ut=(e,t,r,a,o)=>{let i=D(e),l=i?j(e):xe(),s=xe(i);return i||n({parent:e,node:[pe({from:w,target:l}),pe({from:"value",store:1,target:s})],family:{owners:[e,t,r],links:t},meta:{op:o},regional:1}),f('sampleSource',s,l,a),[l,s]},pt=(e,t,r,a)=>{let n=e[t];n&&o({target:n,params:Array.isArray(n)?n.map((()=>r)):r,defer:1,stack:a})},mt=e=>e;exports.allSettled=(e,{scope:t,params:r})=>{if(!F(e))return Promise.reject(new Error('first argument should be unit'));if(!_(e)&&!R(e)&&!D(e))return Promise.reject(new Error('first argument accepts only effects, events and stores'));let a=p();a.parentFork=Ie;let{fxCount:n}=t;W(n.scope.defers,a);let i=[e],l=[];return W(l,_(e)?{params:r,req:{rs(e){a.value={status:'done',value:e}},rj(e){a.value={status:'fail',value:e}}}}:r),W(i,n),W(l,null),o({target:i,params:l,scope:t}),a.req},exports.attach=e=>{let t;[e,t]=s(e,1);let{source:r,effect:a,mapParams:n}=e,i=m(e,t);I(i,'attached',1);let f,{runner:d}=S(i).scope,c=ge(((e,t,a)=>{let l,{params:s,req:f,handler:d}=e,c=i.finally,u=nt(a),p=ot(s,f,0,c,a,u),m=a.a,h=_(d),g=1;if(n?[g,l]=at(n,p,[s,m]):l=r&&h?m:s,g){if(!h)return e.args=[m,l],1;o({target:d,params:{params:l,req:{rs:ot(s,f,1,c,a,u),rj:p}},page:a.page,defer:1})}}),1,1);if(r){let e;D(r)?(e=r,Z(e,[i])):(e=u(r),Z(i,[e])),f=[ye(j(e)),c]}else f=[c];d.seq.splice(1,0,...f),i.use(a);let p=A(a);return p&&(Object.assign(q(i),l(i.shortName,p)),i.defaultConfig.parent=p),Ye(a,i,"effect"),i},exports.clearNode=Je,exports.combine=u,exports.createApi=(...t)=>{let[[r,a],n]=s(t),o={};return e(a,((e,t)=>{let a=o[t]=d(t,{parent:A(r),config:n});r.on(a,e),Ye(r,a)})),o},exports.createDomain=function r(a,i){let l=We({or:i,and:'string'==typeof a?{name:a}:a}),s=n({family:{type:"domain"},regional:1,parent:(null==l?void 0:l.domain)||(null==l?void 0:l.parent)}),f={history:{},graphite:s,hooks:{}};s.meta=Ze("domain",f,{parent:(null==l?void 0:l.domain)||(null==l?void 0:l.parent),or:l}),e({Event:d,Effect:m,Store:c,Domain:r},((e,r)=>{let a=r.toLowerCase(),n=d({named:`on${r}`});f.hooks[a]=n;let i=new Set;f.history[`${a}s`]=i,n.create=e=>(o(n,e),e),W(S(n).seq,ge(((e,t,r)=>(r.scope=null,e)))),n.watch((e=>{Z(f,[e]),i.add(e),e.ownerSet||(e.ownerSet=i),A(e)||(e.parent=f)})),Z(f,[n]),f[`onCreate${r}`]=e=>(t(i,e),n.watch(e)),f[`create${r}`]=f[a]=(t,r)=>{let a=We({and:r,or:t});return null!=a&&a.domain?e(t,r):n(e(t,{parent:f,or:a}))}}));let u=A(f);return u&&e(f.hooks,((e,t)=>Qe(e,u.hooks[t]))),null!=l&&l.domain&&l.domain.hooks.domain(f),f},exports.createEffect=m,exports.createEvent=d,exports.createNode=n,exports.createStore=c,exports.createStoreObject=(...e)=>(H(0,'createStoreObject','combine'),u(...e)),exports.createWatch=({unit:e,fn:t,scope:r})=>{let a=[ve.run({fn:e=>t(e)})];if(r){let t=n({node:a}),o=e.graphite.id,i=r.additionalLinks,l=i[o]||[];return i[o]=l,l.push(t),v((()=>{let e=l.indexOf(t);-1!==e&&l.splice(e,1),Je(t)}))}{let t=n({node:a,parent:[e],family:{owners:e}});return v((()=>{Je(t)}))}},exports.fork=(e,a)=>{let o,i=e;P(e)&&(o=e,i=a);let l=(e=>{let r=n({scope:{defers:[],inFlight:0,fxID:0},node:[ge(((e,t,r)=>{A(r)?'dec'===O(A(r).node,'needFxCounter')?t.inFlight-=1:(t.inFlight+=1,t.fxID+=1):t.fxID+=1})),me({priority:"sampler",batch:1}),ge(((e,r)=>{let{defers:a,fxID:n}=r;r.inFlight>0||0===a.length||Promise.resolve().then((()=>{r.fxID===n&&t(a.splice(0,a.length),(e=>{Re(e.parentFork),e.rs(e.value)}))}))}),0,1)]}),a=n({node:[ge(((e,t,r)=>{let a=A(r);if(a){let t=a.node;if(!O(t,'isCombine')||A(a)&&'combine'!==O(A(a).node,'op')){let a=N(r),n=t.scope.state.id,o=O(t,'sid');a.sidIdMap[o]=n,a.sidValuesMap[o]=e;let i=O(t,'serialize');i&&'ignore'!==i&&(a.sidSerializeMap[o]=i.write)}}}))]}),o=n({node:[ge(((e,t,r)=>{let a=N(r);if(a){let e=A(r);e&&(!O(e.node,'isCombine')||A(e)&&'combine'!==O(A(e).node,'op'))&&(a.warnSerialize=1)}}))]}),i={cloneOf:e,reg:{},sidValuesMap:{},sidIdMap:{},sidSerializeMap:{},getState(e){if('current'in e)return Ve(De,i,null,e).current;let t=S(e);return Ve(De,i,t,t.scope.state,1).current},kind:"scope",graphite:n({family:{type:"domain",links:[r,a,o]},meta:{unit:'fork'},scope:{forkInFlightCounter:r}}),additionalLinks:{},handlers:{},fxCount:r,storeChange:a,warnSerializeNode:o,activeEffects:[]};return i})(o);if(i){let e=i.scope;if(e){let r=e.activeEffects;e.activeEffects=[],l.activeEffects=r,t(r,(e=>e.ref=l))}if(i.values){let e=b(i.values,(e=>r(D(e),'Values map can contain only stores as keys')));Object.assign(l.sidValuesMap,e),l.fromSerialize=!(Array.isArray(i.values)||i.values instanceof Map)}i.handlers&&(l.handlers=b(i.handlers,(e=>r(_(e),"Handlers map can contain only effects as keys"))))}return l},exports.forward=e=>{let t='forward',[{from:r,to:a},o]=s(e,1);return ie(r,t,'"from"'),ie(a,t,'"to"'),le(t,a,'to'),Ke(n({parent:r,child:a,meta:{op:t,config:o},family:{},regional:1}))},exports.fromObservable=e=>{ne(e);let t=x in e?e[x]():e;r(t.subscribe,'expect observable to have .subscribe');let a=d(),n=Ke(a);return t.subscribe({next:a,error:n,complete:n}),a},exports.guard=(...e)=>{let[[t,r],a]=s(e);return r||(r=t,t=r.source),g(r,'guard'),dt('guard',r.clock,t,r.filter,r.target,null,r.name,a,!r.greedy,0,1)},exports.hydrate=(e,{values:t})=>{r(te(t),'values property should be an object');let a,n,i,l=b(t),s=Object.getOwnPropertyNames(l),f=[],d=[];V(e)?(a=e,i=1,r(a.cloneOf,'scope should be created from domain'),n=S(a.cloneOf)):P(e)?n=S(e):r(0,'first argument of hydrate should be domain or scope'),y(n,((e,t)=>{if(L(s,t)){W(f,e);let r=O(e,'serialize');r&&'ignore'!==r&&(l[t]=r.read(l[t])),W(d,l[t])}})),o({target:f,params:d,scope:a}),i&&Object.assign(a.sidValuesMap,l)},exports.is=B,exports.launch=o,exports.merge=h,exports.restore=(t,r,a)=>{if(D(t))return H(0,'restore($store)'),t;if(R(t)||_(t)){let e=A(t),n=c(r,{parent:e,name:t.shortName,and:a});return Qe(_(t)?t.doneData:t,n),e&&e.hooks.store(n),n}let n=Array.isArray(t)?[]:{};return e(t,((e,t)=>n[t]=D(e)?e:c(e,{name:t}))),n},exports.sample=(...e)=>{let t,r,a,n,[[o,i,l],f]=s(e),d=1;return ae(i)&&te(o)&&g(o,"sample")&&(i=o.clock,l=o.fn,d=!o.greedy,n=o.filter,t=o.target,r=o.name,a=o.sid,o=o.source),dt("sample",i,o,n,t,l,r,f,d,1,0,a)},exports.scopeBind=(e,{scope:t,safe:a}={})=>{r(t||Ie||a,'scopeBind cannot be called outside of forked .watch');let n=t||Ie;return _(e)?t=>{let r=p();return o({target:e,params:{params:t,req:r},scope:n}),r.req}:t=>(o({target:e,params:t,scope:n}),t)},exports.serialize=(t,a={})=>{t.warnSerialize&&console.error('There is a store without sid in this scope, its value is omitted');let n=a.ignore?a.ignore.map((({sid:e})=>e)):[],o={};return e(t.sidValuesMap,((e,r)=>{if(L(n,r))return;let a=t.sidIdMap[r];o[r]=(t.sidSerializeMap[r]||mt)(a&&a in t.reg?t.reg[a].current:e)})),'onlyChanges'in a&&!a.onlyChanges&&(r(t.cloneOf,'scope should be created from domain'),y(S(t.cloneOf),((e,r)=>{r in o||L(n,r)||O(e,'isCombine')||'ignore'===O(e,'serialize')||(o[r]=t.getState(e))}))),o},exports.setStoreName=(e,t)=>{e.shortName=t,Object.assign(q(e),l(t,A(e)))},exports.split=(...t)=>{let a,o,i='split',[[l,c],u]=s(t),p=!c;p&&(a=l.cases,c=l.match,o=l.clock,l=l.source);let m=D(c),h=!F(c)&&re(c),g=!m&&!h&&te(c);a||(a={}),p?e(a,((e,t)=>le(i,e,`cases.${t}`))):(r(g,'match should be an object'),e(c,((e,t)=>a[t]=d({derived:1,and:u}))),a.__=d({derived:1,and:u}));let y,b=new Set([].concat(l,o||[],Object.values(a))),v=Object.keys(m||h?a:c);if(m||h)m&&b.add(c),y=[m&&ye(j(c),0,1),me({safe:m,filter:1,pure:!m,fn(e,t,r){let a=String(m?r.a:c(e));pt(t,L(v,a)?a:'__',e,r)}})];else if(g){let t=xe({});t.type='shape';let r,a=[];e(c,((e,n)=>{if(F(e)){r=1,W(a,n),b.add(e);let o=Qe(e,[],[ye(t),ge(((e,t,{a:r})=>r[n]=e))]);if(D(e)){t.current[n]=e.getState();let r=j(e);we(t,{from:r,field:n,type:'field'}),f('splitMatchStore',r,o)}}})),r&&f('splitBase',t),y=[r&&ye(t,0,1),be(((e,t,r)=>{for(let n=0;n<v.length;n++){let o=v[n];if(L(a,o)?r.a[o]:c[o](e))return void pt(t,o,e,r)}pt(t,'__',e,r)}),1)]}else r(0,'expect match to be unit, function or object');let x=n({meta:{op:i},parent:o?[]:l,scope:a,node:y,family:{owners:Array.from(b)},regional:1});if(o&&dt(i,o,l,null,x,null,i,u,0,0,0),!p)return a},exports.step=ve,exports.version="22.4.0",exports.withFactory=({sid:e,name:t,loc:r,method:o,fn:i})=>a(n({meta:{sidRoot:Y(e),name:t,loc:r,method:o}}),i),exports.withRegion=a;
//# sourceMappingURL=effector.cjs.js.map
